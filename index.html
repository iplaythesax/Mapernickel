marker.on('popupopen', (e) => {
  const popup = e.popup.getElement(); // popup DOM root
  const addImageBtn = popup.querySelector('#addImageBtn');
  const fileInput = popup.querySelector('#fileInput');
  const editableText = popup.querySelector('#editableText');
  const deleteButtons = popup.querySelectorAll('.deleteImageBtn');

  addImageBtn.onclick = () => fileInput.click();

  fileInput.onchange = function() {
    const file = fileInput.files[0];
    if (file && file.type.startsWith('image/')) {
      const storageRef = ref(storage, `images/${Date.now()}-${file.name}`);
      uploadBytes(storageRef, file).then(snapshot => {
        getDownloadURL(snapshot.ref).then(url => {
          marker.customImages.push(url);
          renderPopup();
          marker.openPopup(); // refresh popup
        });
      });
    }
  };

  deleteButtons.forEach(btn => {
    btn.onclick = () => {
      const index = parseInt(btn.getAttribute('data-index'));
      marker.customImages.splice(index, 1);
      renderPopup();
      marker.openPopup();
    };
  });

  editableText.ondblclick = () => {
    const textarea = document.createElement('textarea');
    textarea.value = marker.customText;
    textarea.style.width = '100%';
    textarea.style.boxSizing = 'border-box';
    editableText.replaceWith(textarea);
    textarea.focus();

    textarea.onblur = () => {
      marker.customText = textarea.value;
      renderPopup();
      marker.openPopup();
    };
  };
});
