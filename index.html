<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Google Maps Clone</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }
    .pin-form { display: flex; flex-direction: column; gap: 8px; }
    .pin-img { max-width: 200px; margin-top: 8px; border-radius: 6px; }
    .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-save { background: #4caf50; color: white; }
    .btn-delete { background: #f44336; color: white; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>My Map Pins</h2>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- Storage Helpers ---
    function savePins(pins) {
      localStorage.setItem("mapPins", JSON.stringify(pins));
    }
    function loadPins() {
      const saved = localStorage.getItem("mapPins");
      return saved ? JSON.parse(saved) : [];
    }

    let map = L.map("map").setView([37.5665, 126.9780], 12); // Default: Seoul
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    let pins = loadPins();
    let markers = [];

    function renderPins() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      pins.forEach((pin, index) => {
        let marker = L.marker([pin.lat, pin.lng]).addTo(map);

        let popupContent = `
          <h3>${pin.title || "Untitled"}</h3>
          <p>${pin.note || ""}</p>
          ${pin.img ? `<img src="${pin.img}" class="pin-img"/>` : ""}
          <button class="btn btn-delete" onclick="deletePin(${index})">Delete</button>
        `;

        marker.bindPopup(popupContent);
        markers.push(marker);
      });
    }

    function addPin(lat, lng) {
      let formHtml = `
        <div class="pin-form">
          <input type="text" id="pinTitle" placeholder="Title" />
          <textarea id="pinNote" placeholder="Note"></textarea>
          <input type="file" id="pinImage" accept="image/*" />
          <button class="btn btn-save" onclick="savePin(${lat}, ${lng})">Save</button>
        </div>
      `;
      L.popup()
        .setLatLng([lat, lng])
        .setContent(formHtml)
        .openOn(map);
    }

    function savePin(lat, lng) {
      let title = document.getElementById("pinTitle").value;
      let note = document.getElementById("pinNote").value;
      let fileInput = document.getElementById("pinImage");

      if (fileInput.files.length > 0) {
        let file = fileInput.files[0];
        let reader = new FileReader();
        reader.onload = function(e) {
          let imgData = e.target.result; // base64 string
          pins.push({ lat, lng, title, note, img: imgData });
          savePins(pins);
          renderPins();
          map.closePopup();
        };
        reader.readAsDataURL(file);
      } else {
        pins.push({ lat, lng, title, note, img: null });
        savePins(pins);
        renderPins();
        map.closePopup();
      }
    }

    function deletePin(index) {
      pins.splice(index, 1);
      savePins(pins);
      renderPins();
    }

    // Attach functions to window so popup buttons work
    window.savePin = savePin;
    window.deletePin = deletePin;

    // Map click â†’ add pin
    map.on("click", (e) => {
      addPin(e.latlng.lat, e.latlng.lng);
    });

    // Render saved pins on load
    renderPins();
  </script>
</body>
</html>
