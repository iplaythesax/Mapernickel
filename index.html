<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Persistent Map Pins with Sidebar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; display:flex; }
    #map { flex:1; height:100vh; }
    #sidebar { width:300px; background:#f9f9f9; overflow-y:auto; padding:10px; box-shadow:-2px 0 6px rgba(0,0,0,0.15); font-family:sans-serif; }
    .pin-img { max-width:100%; margin-bottom:6px; border-radius:6px; cursor:pointer; }
    .pin-form { display:flex; flex-direction:column; gap:8px; min-width:220px; }
    .btn { padding:6px 10px; border-radius:6px; border:0; cursor:pointer; }
    .btn-save { background:#2196f3; color:white; }
    .btn-delete { background:#f44336; color:white; margin-top:5px; }
    .preview-grid img { max-width:100%; margin-bottom:6px; border-radius:6px; cursor:pointer; }
    .topbar { position: absolute; left:10px; top:10px; z-index:1000; background:rgba(255,255,255,0.95); padding:6px 10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
    h3 { margin:6px 0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h3>Pin Images</h3>
    <div id="sidebarImages">Click a pin to view its images here.</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const STORAGE_KEY = "persistentMapPins_v2";
    let pins = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    let markers = [];
    let popupCounter = 0;
    const tempImages = {};

    const map = L.map("map").setView([37.5665, 126.9780], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19 }).addTo(map);

    function savePins() { localStorage.setItem(STORAGE_KEY, JSON.stringify(pins)); }

    function escapeHtml(str) {
      if (!str) return "";
      return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function readFilesAsDataURLs(fileList) {
      const files = Array.from(fileList);
      return Promise.all(files.map(file => new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = () => rej(new Error("File read error"));
        r.readAsDataURL(file);
      })));
    }

    function renderPins() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      pins.forEach((pin, i) => {
        const m = L.marker([pin.lat, pin.lng]).addTo(map);
        let html = `<div style="min-width:220px;">
                      <h3>${escapeHtml(pin.title||"Untitled")}</h3>
                      <div>${escapeHtml(pin.note||"")}</div>
                      <button class="btn btn-delete" onclick="window.deletePin(${i})">Delete</button>
                    </div>`;
        m.bindPopup(html);
        m.on("click", () => renderSidebarImages(pin));
        markers.push(m);
      });
    }

    function addPin(lat,lng) {
      popupCounter++;
      const id = popupCounter;
      const titleId = `pinTitle-${id}`, noteId=`pinNote-${id}`, inputId=`pinImage-${id}`, previewId=`pinPreview-${id}`, saveBtnId=`pinSave-${id}`;

      const content = `<div class="pin-form">
        <input id="${titleId}" placeholder="Title"/>
        <textarea id="${noteId}" rows="3" placeholder="Note"></textarea>
        <input id="${inputId}" type="file" accept="image/*" multiple onchange="window.previewImages(event,${id})"/>
        <div id="${previewId}" class="preview-grid"></div>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-save" id="${saveBtnId}" onclick="window.savePin(${id},${lat},${lng})">Save</button>
          <button class="btn" onclick="map.closePopup()">Cancel</button>
        </div>
      </div>`;

      L.popup({ maxWidth:400, minWidth:220 }).setLatLng([lat,lng]).setContent(content).openOn(map);
      tempImages[id] = [];
    }

    window.previewImages = async function(event, popupId) {
      const files = event.target.files;
      if(!files || files.length===0){ tempImages[popupId]=[]; document.getElementById(`pinPreview-${popupId}`).innerHTML=""; return;}
      const dataURLs = await readFilesAsDataURLs(files);
      tempImages[popupId] = dataURLs.slice();
      document.getElementById(`pinPreview-${popupId}`).innerHTML = dataURLs.map(d=>`<img src="${d}" class="pin-img" onclick="window.open(this.src)"/>`).join("");
    };

    window.savePin = async function(popupId, lat, lng) {
      const title = document.getElementById(`pinTitle-${popupId}`).value;
      const note  = document.getElementById(`pinNote-${popupId}`).value;
      const images = tempImages[popupId] ? tempImages[popupId].slice() : [];
      pins.push({lat,lng,title,note,images});
      savePins(); tempImages[popupId]=[]; map.closePopup(); renderPins(); renderSidebarImages(pins[pins.length-1]);
    };

    window.deletePin = function(index) {
      if(!confirm("Delete this pin?")) return;
      pins.splice(index,1); savePins(); renderPins(); document.getElementById("sidebarImages").innerHTML="Click a pin to view its images here.";
    };

    function renderSidebarImages(pin){
      const container = document.getElementById("sidebarImages");
      if(!pin.images || pin.images.length===0){ container.innerHTML="<i>No images for this pin</i>"; return; }
      container.innerHTML = pin.images.map(img=>`<img src="${img}" class="pin-img" onclick="window.open(this.src)"/>`).join("");
    }

    map.on("click",(e)=>addPin(e.latlng.lat,e.latlng.lng));
    renderPins();
  </script>
</body>
</html>
