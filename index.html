<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interactive Map with Editable Notes</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  html, body { margin:0; padding:0; height:100%; }
  #map { width:100%; height:100%; }
  .popup-content img { max-width:200px; display:block; margin-bottom:5px; }
  .popup-content button { margin:2px 0; }
  .editable-text { cursor: pointer; border-bottom: 1px dotted #888; display: inline-block; }
</style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase v12 modular SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAoTpaWPuqb__Jk9uipns0aRpud0sIG9rk",
    authDomain: "mapernickel.firebaseapp.com",
    projectId: "mapernickel",
    storageBucket: "mapernickel.appspot.com",
    messagingSenderId: "1098451360374",
    appId: "1:1098451360374:web:9a87f7693e71e813fd9d57",
    measurementId: "G-759J0EHB7K"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const storage = getStorage(app);

  // Wait for DOM
  document.addEventListener("DOMContentLoaded", () => {
    const map = L.map('map', { doubleClickZoom: false }).setView([36.5, 127.8], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    L.Icon.Default.mergeOptions({
      iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon.png',
      shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png'
    });

    let markers = [];
    let deletedStack = [];

    function addMarker(lat, lng, text="", images=[]) {
      const marker = L.marker([lat, lng]).addTo(map);
      marker.customText = text;
      marker.customImages = images;

      function renderPopup() {
        let html = '<div class="popup-content">';
        marker.customImages.forEach((img, index) => {
          html += `<div>
            <img src="${img}" alt="image">
            <button data-index="${index}" class="deleteImageBtn">Delete Image</button>
          </div>`;
        });
        html += `<div class="editable-text" id="editableText">${marker.customText || "Double-click to add note"}</div>`;
        html += `<br>
          <button id="addImageBtn">Add Image</button>
          <input type="file" id="fileInput" accept="image/*" style="display:none" />
        `;
        html += '</div>';
        marker.bindPopup(html);
      }

      renderPopup();

      marker.on('popupopen', () => {
        const addImageBtn = document.getElementById('addImageBtn');
        const fileInput = document.getElementById('fileInput');
        const editableText = document.getElementById('editableText');
        const deleteButtons = document.querySelectorAll('.deleteImageBtn');

        addImageBtn.onclick = () => fileInput.click();

        fileInput.onchange = function() {
          const file = fileInput.files[0];
          if (file && file.type.startsWith('image/')) {
            const storageRef = ref(storage, `images/${Date.now()}-${file.name}`);
            uploadBytes(storageRef, file).then(snapshot => {
              getDownloadURL(snapshot.ref).then(url => {
                marker.customImages.push(url);
                renderPopup();
                marker.openPopup(); // refresh popup
              });
            });
          }
        };

        deleteButtons.forEach(btn => {
          btn.onclick = () => {
            const index = parseInt(btn.getAttribute('data-index'));
            marker.customImages.splice(index, 1);
            renderPopup();
            marker.openPopup();
          };
        });

        editableText.ondblclick = () => {
          const textarea = document.createElement('textarea');
          textarea.value = marker.customText;
          textarea.style.width = '100%';
          textarea.style.boxSizing = 'border-box';
          editableText.replaceWith(textarea);
          textarea.focus();

          textarea.onblur = () => {
            marker.customText = textarea.value;
            renderPopup();
            marker.openPopup();
          };
        };
      });

      marker.on('contextmenu', () => {
        if (confirm('Are you sure you want to delete this marker?')) {
          map.removeLayer(marker);
          markers = markers.filter(m => m !== marker);
          deletedStack.push({ lat, lng, text: marker.customText, images: marker.customImages });
        }
      });

      markers.push(marker);
      return marker;
    }

    map.on('dblclick', e => addMarker(e.latlng.lat, e.latlng.lng));

    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
        const last = deletedStack.pop();
        if (last) addMarker(last.lat, last.lng, last.text, last.images);
      }
    });
  });
</script>
</body>
</html>
